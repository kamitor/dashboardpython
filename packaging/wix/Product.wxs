<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX 4.x MSI installer scaffold for PACKAGE_NAME.
  TODO: Replace PACKAGE_NAME, ORGANIZATION, COMPANY_NAME, SIGNING_IDENTITY.

  Prerequisites:
    winget install WiXToolset.WiXToolset      (WiX 4.x)
    dotnet tool install --global wix

  Build locally:
    wix build packaging\wix\Product.wxs \
        -d ProductVersion=$(APP_VERSION) \
        -d BinDir=dist\PACKAGE_NAME \
        -out dist\PACKAGE_NAME-$(APP_VERSION)-windows-x86_64.msi

  Reference: https://wixtoolset.org/docs/
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package
    Name="PACKAGE_NAME"
    Manufacturer="COMPANY_NAME"
    Version="$(ProductVersion)"
    UpgradeCode="PUT-A-NEW-GUID-HERE"
    Language="1033"
    Codepage="1252"
    InstallerVersion="500"
    Compressed="yes">

    <!-- Upgrade handling: remove older versions on install -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowDowngrades="no" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Standard WiX UI with license page -->
    <ui:WixUI Id="WixUI_InstallDir" />

    <WixVariable Id="WixUILicenseRtf" Value="packaging\wix\License.rtf" />
    <!-- TODO: create packaging/wix/License.rtf -->

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- ── Directory structure ────────────────────────────────────────── -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="MANUFACTURERFOLDER" Name="COMPANY_NAME">
        <Directory Id="INSTALLFOLDER" Name="PACKAGE_NAME" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="PACKAGE_NAME" />
    </StandardDirectory>

    <!-- ── Components ─────────────────────────────────────────────────── -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">

      <!-- Main executable — sourced from the PyInstaller onefile build -->
      <Component Id="MainExecutable">
        <File Id="PACKAGE_NAMEexe"
              Source="$(BinDir)\PACKAGE_NAME.exe"
              KeyPath="yes" />
        <!-- Add to PATH -->
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>

      <!-- Start menu shortcut -->
      <Component Id="StartMenuShortcut" Directory="ApplicationProgramsFolder">
        <Shortcut Id="AppStartMenuShortcut"
                  Name="PACKAGE_NAME"
                  Description="TODO: one-line description"
                  Target="[INSTALLFOLDER]PACKAGE_NAME.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanupStartMenu"
                      Directory="ApplicationProgramsFolder"
                      On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\ORGANIZATION\PACKAGE_NAME"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>

    </ComponentGroup>

    <!-- ── Feature tree ───────────────────────────────────────────────── -->
    <Feature Id="ProductFeature" Title="PACKAGE_NAME" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>

  </Package>
</Wix>
