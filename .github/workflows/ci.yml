# =============================================================================
# .github/workflows/ci.yml — continuous integration
# =============================================================================
# Runs on every push to main and every pull request.
# Matrix: {ubuntu, windows, macos} × {Python 3.10 – 3.13}
#
# SECURITY NOTES:
#   • All third-party actions are pinned to full commit SHAs.
#   • Permissions default to read-only; individual jobs escalate only what
#     they need (principle of least privilege).
#   • Dependabot (see .github/dependabot.yml) keeps SHA pins current.
#   • Checkout uses SSH deploy key — NO HTTPS, NO PAT.
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:

# Cancel superseded runs on the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Repository-wide read-only default
permissions:
  contents: read

jobs:
  # ── Lint + type-check (fast, Linux-only) ──────────────────────────────────
  lint:
    name: Lint / mypy
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Set up Python 3.12
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Ruff — lint
        run: ruff check . --output-format=github

      - name: Ruff — format check
        run: ruff format --check .

      - name: mypy — type check
        run: mypy

  # ── Tests (full matrix) ───────────────────────────────────────────────────
  test:
    name: Test / ${{ matrix.os }} / Python ${{ matrix.python-version }}
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    permissions:
      contents: read

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0   # hatch-vcs needs full history

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install project + dev deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest
        run: pytest --tb=short --strict-markers

      - name: Upload coverage (Linux / 3.12 only)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: coverage-report
          path: .coverage
          retention-days: 7

  # ── Build smoke (validate the packaging spec parses) ─────────────────────
  packaging-smoke:
    name: Packaging smoke / ${{ matrix.os }}
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    permissions:
      contents: read

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip build
          pip install -e ".[dev]"

      - name: Verify sdist builds cleanly
        run: python -m build --sdist --no-isolation

      - name: Verify wheel builds cleanly
        run: python -m build --wheel --no-isolation
