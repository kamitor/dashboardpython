name: Build Desktop App

on:
  push:
    branches: [main]
  pull_request:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact-name: windows
          - os: macos-latest
            artifact-name: macos
          - os: ubuntu-latest
            artifact-name: linux

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Set build metadata
        shell: bash
        run: |
          RAW_VERSION="${GITHUB_REF_NAME:-dev}"
          CLEAN_VERSION="${RAW_VERSION#v}"

          if [[ "$CLEAN_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="$CLEAN_VERSION"
          else
            VERSION="0.0.0"
          fi

          echo "APP_VERSION=$VERSION"               >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=$GITHUB_RUN_NUMBER"     >> "$GITHUB_ENV"
          echo "COMMIT_SHA=$GITHUB_SHA"              >> "$GITHUB_ENV"
          echo "REPO_NAME=${GITHUB_REPOSITORY#*/}"   >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # -- Linux: Qt system libraries for headless build --
      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxkbcommon-x11-0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libegl1 \
            libglib2.0-0

      # -- Windows: version metadata for exe properties --
      - name: Generate Windows version-info file
        if: runner.os == 'Windows'
        shell: python
        run: |
          import os

          version = os.environ["APP_VERSION"]
          parts = version.split(".")
          major = int(parts[0]) if len(parts) > 0 else 0
          minor = int(parts[1]) if len(parts) > 1 else 0
          patch = int(parts[2]) if len(parts) > 2 else 0
          repo  = os.environ.get("REPO_NAME", "MyApp")

          content = f"""# UTF-8
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=({major}, {minor}, {patch}, 0),
              prodvers=({major}, {minor}, {patch}, 0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                  StringTable(
                    u'040904B0',
                    [
                      StringStruct(u'CompanyName',      u''),
                      StringStruct(u'FileDescription',  u'{repo}'),
                      StringStruct(u'FileVersion',      u'{version}'),
                      StringStruct(u'InternalName',     u'{repo}'),
                      StringStruct(u'OriginalFilename', u'{repo}.exe'),
                      StringStruct(u'ProductName',      u'{repo}'),
                      StringStruct(u'ProductVersion',   u'{version}'),
                    ]
                  )
                ]
              ),
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          """

          os.makedirs("packaging", exist_ok=True)
          with open("packaging/windows-version.txt", "w") as f:
              f.write(content)

      # -- Build: Windows --
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $iconArg = @()
          if (Test-Path "assets/icon.ico") {
            $iconArg = @("--icon", "assets/icon.ico")
          }
          pyinstaller `
            --clean `
            --noconfirm `
            --windowed `
            --onefile `
            @iconArg `
            --version-file packaging/windows-version.txt `
            --name "${{ env.REPO_NAME }}" `
            app/main.py

      # -- Build: macOS --
      - name: Build macOS
        if: runner.os == 'macOS'
        run: |
          ICON_ARG=""
          if [ -f "assets/icon.icns" ]; then
            ICON_ARG="--icon assets/icon.icns"
          elif [ -f "assets/icon.ico" ]; then
            ICON_ARG="--icon assets/icon.ico"
          fi
          pyinstaller \
            --clean \
            --noconfirm \
            --windowed \
            --onefile \
            $ICON_ARG \
            --name "${{ env.REPO_NAME }}" \
            app/main.py

      # -- Build: Linux --
      - name: Build Linux
        if: runner.os == 'Linux'
        run: |
          pyinstaller \
            --clean \
            --noconfirm \
            --onefile \
            --name "${{ env.REPO_NAME }}" \
            app/main.py

      # -- Rename with version and platform for release --
      - name: Rename artifact
        shell: bash
        run: |
          cd dist
          for f in *; do
            name="${f%.*}"
            ext="${f##*.}"
            if [ "$name" = "$ext" ]; then
              mv "$f" "${f}-${{ env.APP_VERSION }}-${{ matrix.artifact-name }}"
            else
              mv "$f" "${name}-${{ env.APP_VERSION }}-${{ matrix.artifact-name }}.${ext}"
            fi
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_NAME }}-${{ matrix.artifact-name }}
          path: dist/*

  # -- Attach artifacts to GitHub Release --
  upload-to-release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
