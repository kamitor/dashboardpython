name: Build Desktop App

on:
  push:
    branches:
      - main
  pull_request:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Set build metadata
        shell: bash
        run: |
          # For tagged releases use the tag, otherwise default to 0.0.0
          RAW_VERSION="${GITHUB_REF_NAME:-dev}"
          CLEAN_VERSION="${RAW_VERSION#v}"

          # Only keep the version if it looks like semver (digits.digits.digits)
          if [[ "$CLEAN_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="$CLEAN_VERSION"
          else
            VERSION="0.0.0"
          fi

          echo "APP_VERSION=$VERSION"           >> $GITHUB_ENV
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${GITHUB_SHA}"        >> $GITHUB_ENV
          echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # ── Linux: install Qt system libraries for headless build ──
      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxkbcommon-x11-0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libegl1 \
            libglib2.0-0

      # ── Windows: WiX Toolset for MSI installer ──
      - name: Install WiX Toolset
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install wixtoolset --no-progress -y
          # Add WiX to PATH for this job
          $wixDir = (Get-ChildItem "C:\Program Files (x86)\WiX Toolset v3*\bin" | Select-Object -First 1).FullName
          echo "$wixDir" | Out-File -Append $env:GITHUB_PATH

      - name: Generate Windows version file
        if: runner.os == 'Windows'
        shell: python
        run: |
          import os

          version = os.environ["APP_VERSION"]  # already cleaned (e.g. "0.6.0")
          parts = version.split(".")
          major = int(parts[0]) if len(parts) > 0 else 0
          minor = int(parts[1]) if len(parts) > 1 else 0
          patch = int(parts[2]) if len(parts) > 2 else 0

          content = f"""VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=({major}, {minor}, {patch}, 0),
              prodvers=({major}, {minor}, {patch}, 0),
              mask=0x3f,
              flags=0x0,
              OS=0x4,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[]
          )
          """

          os.makedirs("packaging", exist_ok=True)
          with open("packaging/windows-version.txt", "w") as f:
              f.write(content)

      # ── Windows build ──
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $iconArg = @()
          if (Test-Path "assets/icon.ico") {
            $iconArg = @("--icon", "assets/icon.ico")
          }
          pyinstaller `
            --clean `
            --noconfirm `
            --windowed `
            --onefile `
            @iconArg `
            --version-file packaging/windows-version.txt `
            --name "${{ env.REPO_NAME }}-${{ env.APP_VERSION }}" `
            app/main.py

      - name: Build MSI Installer
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $AppName    = "${{ env.REPO_NAME }}"
          $Version    = "${{ env.APP_VERSION }}"
          $SourceExe  = "dist\$AppName-$Version.exe"

          candle packaging\installer.wxs `
            "-dAppName=$AppName" `
            "-dSourceExe=$SourceExe" `
            "-dProductVersion=$Version"

          light installer.wixobj `
            -o dist\$AppName-$Version.msi

      # ── macOS build ──
      - name: Build macOS
        if: runner.os == 'macOS'
        run: |
          ICON_ARG=""
          if [ -f "assets/icon.ico" ]; then
            ICON_ARG="--icon assets/icon.ico"
          fi
          pyinstaller \
            --clean \
            --noconfirm \
            --windowed \
            --onefile \
            $ICON_ARG \
            --name "${{ env.REPO_NAME }}-${{ env.APP_VERSION }}" \
            app/main.py

      # ── Linux build ──
      - name: Build Linux
        if: runner.os == 'Linux'
        run: |
          pyinstaller \
            --clean \
            --noconfirm \
            --onefile \
            --name "${{ env.REPO_NAME }}-${{ env.APP_VERSION }}" \
            app/main.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_NAME }}-${{ matrix.os }}-${{ env.APP_VERSION }}
          path: dist/*

  upload-to-release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*
