# =============================================================================
# .github/workflows/release.yml — full release pipeline
# =============================================================================
# Triggered by pushing a version tag: git tag v1.2.3 && git push origin v1.2.3
#
# Pipeline stages:
#   1. metadata    — extract version from tag
#   2. test        — full test matrix (gate)
#   3. wheels      — cibuildwheel (sdist + wheels for all platforms/Pythons)
#   4. build-linux — PyInstaller onefile, Nuitka, AppImage, .deb, .rpm, .tar.gz
#   5. build-macos — PyInstaller .app + zip, Nuitka, DMG scaffold
#   6. build-win   — PyInstaller onefile + onedir zip, Nuitka, MSI scaffold
#   7. attest      — SLSA build provenance + SBOM (Sigstore keyless)
#   8. release     — create GitHub Release with all artifacts
#   9. publish     — publish wheels to PyPI via OIDC (no PAT, no password)
#
# SECURITY:
#   • All actions pinned to full commit SHAs (supply-chain hardening).
#   • Permissions are minimal per-job.
#   • PyPI publishing uses OIDC trusted publishing (no long-lived token).
#   • Checkout uses SSH deploy key — NO HTTPS, NO PAT.
#   • fail-fast: false — so a single platform failure doesn't abort the release.
# =============================================================================

name: Release

on:
  push:
    tags:
      - "v[0-9]*.[0-9]*.[0-9]*"

# Never cancel an in-flight release run
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

# Repo-wide read-only default
permissions:
  contents: read

# ── TODO markers ──────────────────────────────────────────────────────────────
# Replace in this file AND in pyproject.toml:
#   PACKAGE_NAME       → your Python package name
#   ORGANIZATION       → your GitHub organisation or username
#   PYPI_PROJECT_NAME  → your PyPI project name (may differ from PACKAGE_NAME)

env:
  APP_NAME: PACKAGE_NAME  # TODO

# =============================================================================
jobs:
  # ── 1. Extract version from tag ───────────────────────────────────────────
  metadata:
    name: Metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version:  ${{ steps.tag.outputs.version }}
      app-name: ${{ env.APP_NAME }}

    steps:
      - id: tag
        name: Extract version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

  # ── 2. Test gate (must pass before any artifacts are built) ──────────────
  test:
    name: Test / ${{ matrix.os }} / Python ${{ matrix.python }}
    needs: metadata
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:     [ubuntu-latest, windows-latest, macos-latest]
        python: ["3.10", "3.11", "3.12", "3.13"]
    permissions:
      contents: read

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ matrix.python }}
          cache: pip

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint
        run: ruff check . --output-format=github

      - name: Type check
        run: mypy

      - name: pytest
        run: pytest --tb=short --strict-markers

  # ── 3. Wheels via cibuildwheel ────────────────────────────────────────────
  wheels:
    name: Wheels / ${{ matrix.os }}
    needs: [metadata, test]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    permissions:
      contents: read

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"

      # aarch64 Linux cross-compilation requires QEMU
      - name: Set up QEMU (Linux aarch64)
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3.7.0
        with:
          platforms: arm64

      - name: Build sdist
        if: matrix.os == 'ubuntu-latest'
        run: |
          pip install build
          python -m build --sdist --outdir wheelhouse/

      - name: Build wheels (cibuildwheel)
        uses: pypa/cibuildwheel@fbc29a34228fe4bac2b01f38a1e1e3c7d01be69f  # v2.21.3
        with:
          output-dir: wheelhouse
        env:
          CIBW_BUILD_VERBOSITY: 1

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/
          retention-days: 1

  # ── 4. Linux binaries ─────────────────────────────────────────────────────
  build-linux:
    name: Build / Linux
    needs: [metadata, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      APP_VERSION: ${{ needs.metadata.outputs.version }}
      ARCH:        x86_64

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyinstaller nuitka ordered-set zstandard patchelf

      - name: Install nfpm
        run: |
          curl -sfL https://install.goreleaser.com/github.com/goreleaser/nfpm.sh | sh
          sudo mv ./bin/nfpm /usr/local/bin/nfpm
          nfpm --version

      # ── PyInstaller onefile ──────────────────────────────────────────────
      - name: PyInstaller — onefile
        env:
          BUILD_MODE: onefile
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_pyinstaller.sh

      - name: Smoke test — onefile binary
        run: |
          ./dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64-onefile --version

      # ── PyInstaller onedir (tar.gz) ──────────────────────────────────────
      - name: PyInstaller — onedir → tar.gz
        env:
          BUILD_MODE: onedir
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_pyinstaller.sh

      # ── Nuitka ──────────────────────────────────────────────────────────
      - name: Nuitka — standalone
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_nuitka.sh

      - name: Smoke test — Nuitka binary
        run: |
          ./dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64-nuitka --version

      # ── AppImage ─────────────────────────────────────────────────────────
      - name: AppImage
        run: |
          # Symlink the onefile binary where build_appimage.sh expects it
          cp dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64-onefile \
             dist/${{ env.APP_NAME }}
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_appimage.sh

      - name: Smoke test — AppImage
        run: |
          chmod +x dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64.AppImage
          dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64.AppImage --version

      # ── .deb + .rpm via nfpm ─────────────────────────────────────────────
      - name: Build .deb
        run: |
          cp dist/release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-x86_64-onefile \
             dist/${{ env.APP_NAME }}
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_deb.sh

      - name: Build .rpm
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_rpm.sh

      # ── Upload artifacts ─────────────────────────────────────────────────
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: dist-linux
          path: dist/release/
          retention-days: 1

  # ── 5. macOS binaries ─────────────────────────────────────────────────────
  build-macos:
    name: Build / macOS
    needs: [metadata, test]
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      APP_VERSION: ${{ needs.metadata.outputs.version }}
      ARCH:        universal2

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python 3.12 (universal2)
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyinstaller nuitka ordered-set zstandard

      # ── PyInstaller .app bundle (onedir mode for macOS signing) ──────────
      - name: PyInstaller — .app bundle
        env:
          BUILD_MODE: onedir
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          ARCH=universal2 bash scripts/build_pyinstaller.sh

      # ── Zipped .app ───────────────────────────────────────────────────────
      - name: Zip .app bundle
        run: |
          cd dist
          zip -r "release/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macos-universal2.app.zip" \
              "${{ env.APP_NAME }}.app"

      # ── Smoke test .app (headless, --version only) ────────────────────────
      - name: Smoke test — .app binary
        run: |
          "dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}" --version

      # ── Nuitka ───────────────────────────────────────────────────────────
      - name: Nuitka — standalone
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          ARCH=arm64 bash scripts/build_nuitka.sh

      # ── DMG scaffold (create-dmg if available, hdiutil fallback) ─────────
      - name: DMG scaffold
        run: |
          export APP_NAME="${{ env.APP_NAME }}"
          bash scripts/build_dmg.sh || echo "::warning::DMG creation failed (non-fatal; attach create-dmg)"

      # ── Optional: macOS code signing (disabled by default) ───────────────
      # Requires secrets: MACOS_CERTIFICATE, MACOS_CERTIFICATE_PWD,
      #                   MACOS_KEYCHAIN_PASSWORD, APPLE_ID, APPLE_TEAM_ID,
      #                   APPLE_APP_SPECIFIC_PASSWORD
      #
      # - name: Import signing certificate
      #   if: env.MACOS_CERTIFICATE != ''
      #   env:
      #     MACOS_CERTIFICATE:     ${{ secrets.MACOS_CERTIFICATE }}
      #     MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      #     MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
      #   run: |
      #     echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
      #     security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
      #     security default-keychain -s build.keychain
      #     security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
      #     security import certificate.p12 \
      #         -k build.keychain \
      #         -P "$MACOS_CERTIFICATE_PWD" \
      #         -T /usr/bin/codesign
      #     security set-key-partition-list \
      #         -S apple-tool:,apple: \
      #         -s -k "$MACOS_KEYCHAIN_PASSWORD" build.keychain
      #     rm certificate.p12
      #
      # - name: Code sign .app
      #   run: |
      #     codesign --deep --force --verify --verbose \
      #         --sign "SIGNING_IDENTITY" \
      #         --entitlements packaging/macos/entitlements.plist \
      #         --options runtime \
      #         "dist/${{ env.APP_NAME }}.app"
      #
      # - name: Notarize
      #   env:
      #     APPLE_ID:                  ${{ secrets.APPLE_ID }}
      #     APPLE_TEAM_ID:             ${{ secrets.APPLE_TEAM_ID }}
      #     APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      #   run: |
      #     # Zip for submission (DMG or zip)
      #     ditto -c -k --keepParent \
      #         "dist/${{ env.APP_NAME }}.app" \
      #         "dist/${{ env.APP_NAME }}-notarize.zip"
      #     xcrun notarytool submit \
      #         "dist/${{ env.APP_NAME }}-notarize.zip" \
      #         --apple-id   "$APPLE_ID" \
      #         --team-id    "$APPLE_TEAM_ID" \
      #         --password   "$APPLE_APP_SPECIFIC_PASSWORD" \
      #         --wait
      #     xcrun stapler staple "dist/${{ env.APP_NAME }}.app"
      #     rm "dist/${{ env.APP_NAME }}-notarize.zip"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: dist-macos
          path: dist/release/
          retention-days: 1

  # ── 6. Windows binaries ───────────────────────────────────────────────────
  build-windows:
    name: Build / Windows
    needs: [metadata, test]
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      APP_VERSION: ${{ needs.metadata.outputs.version }}
      ARCH:        x86_64

    steps:
      - name: Checkout (SSH)
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyinstaller nuitka ordered-set zstandard

      # ── PyInstaller onefile .exe ─────────────────────────────────────────
      - name: PyInstaller — onefile .exe
        shell: powershell
        env:
          BUILD_MODE: onefile
        run: |
          $env:APP_NAME = "${{ env.APP_NAME }}"
          .\scripts\build_pyinstaller.ps1

      - name: Smoke test — onefile .exe
        shell: cmd
        run: |
          dist\release\${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-x86_64-onefile.exe --version

      # ── PyInstaller onedir (portable zip) ───────────────────────────────
      - name: PyInstaller — onedir → portable zip
        shell: powershell
        env:
          BUILD_MODE: onedir
        run: |
          $env:APP_NAME = "${{ env.APP_NAME }}"
          .\scripts\build_pyinstaller.ps1

      # ── Nuitka ──────────────────────────────────────────────────────────
      - name: Nuitka — standalone .exe
        shell: powershell
        run: |
          $env:APP_NAME = "${{ env.APP_NAME }}"
          .\scripts\build_nuitka.ps1

      - name: Smoke test — Nuitka .exe
        shell: cmd
        run: |
          dist\release\${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-x86_64-nuitka.exe --version

      # ── WiX MSI scaffold ─────────────────────────────────────────────────
      # Requires WiX 4 installed: dotnet tool install --global wix
      - name: MSI scaffold (WiX 4)
        shell: powershell
        continue-on-error: true   # non-fatal: WiX may not be installed on runner
        run: |
          dotnet tool install --global wix 2>$null || true
          $binDir = "dist\${{ env.APP_NAME }}"
          New-Item -ItemType Directory -Force -Path $binDir | Out-Null
          Copy-Item "dist\release\${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-x86_64-onefile.exe" `
                    "$binDir\${{ env.APP_NAME }}.exe"
          wix build packaging\wix\Product.wxs `
              -d "ProductVersion=${{ env.APP_VERSION }}" `
              -d "BinDir=$binDir" `
              -out "dist\release\${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-x86_64.msi" `
              -ext WixToolset.UI.wixext
          Write-Host "==> MSI created."

      # ── Optional: Windows code signing (Authenticode) ────────────────────
      # Requires secret: WINDOWS_CERTIFICATE (base64 PFX), WINDOWS_CERT_PASSWORD
      #
      # - name: Sign executables
      #   if: env.WINDOWS_CERTIFICATE != ''
      #   shell: powershell
      #   env:
      #     WINDOWS_CERTIFICATE:     ${{ secrets.WINDOWS_CERTIFICATE }}
      #     WINDOWS_CERT_PASSWORD:   ${{ secrets.WINDOWS_CERT_PASSWORD }}
      #   run: |
      #     $cert = [System.Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
      #     [System.IO.File]::WriteAllBytes("cert.pfx", $cert)
      #     $artifacts = Get-ChildItem -Path "dist\release" -Include "*.exe","*.msi" -Recurse
      #     foreach ($f in $artifacts) {
      #       signtool sign /fd sha256 /p7 sha256 /f cert.pfx /p $env:WINDOWS_CERT_PASSWORD `
      #                     /tr http://timestamp.digicert.com /td sha256 $f.FullName
      #     }
      #     Remove-Item cert.pfx

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: dist-windows
          path: dist/release/
          retention-days: 1

  # ── 7. SLSA Build Provenance + SBOM attestation ───────────────────────────
  attest:
    name: Attest artifacts
    needs: [wheels, build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents:     read
      id-token:     write      # required for OIDC / Sigstore keyless signing
      attestations: write      # required for actions/attest-*

    steps:
      - name: Download all dist artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444306234fca9e92e15bce55  # v4.1.8
        with:
          pattern: dist-*
          merge-multiple: true
          path: all-artifacts/

      - name: Download wheel artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444306234fca9e92e15bce55  # v4.1.8
        with:
          pattern: wheels-*
          merge-multiple: true
          path: all-artifacts/

      - name: Generate SLSA build provenance
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669b1  # v2.2.3
        with:
          subject-path: "all-artifacts/**"

      - name: Generate SBOM attestation
        uses: actions/attest-sbom@v3
        with:
          subject-path: "all-artifacts/**"
          sbom-format:  spdx-json

      - name: Re-upload attested artifacts
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5  # v4.4.3
        with:
          name: all-artifacts-attested
          path: all-artifacts/
          retention-days: 7

  # ── 8. GitHub Release ─────────────────────────────────────────────────────
  release:
    name: GitHub Release
    needs: [metadata, attest]
    runs-on: ubuntu-latest
    permissions:
      contents: write   # create release + upload assets

    steps:
      - name: Download attested artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444306234fca9e92e15bce55  # v4.1.8
        with:
          name: all-artifacts-attested
          path: release-assets/

      - name: List release assets
        run: |
          echo "=== Release assets ==="
          find release-assets/ -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@e7a8f85ef1c1e94d19cc7cdf8a49a765c39c4a0b  # v2.1.0
        with:
          tag_name:              ${{ github.ref_name }}
          name:                  "${{ env.APP_NAME }} ${{ needs.metadata.outputs.version }}"
          body: |
            ## ${{ env.APP_NAME }} ${{ needs.metadata.outputs.version }}

            ### Downloads

            | Platform | Format | File |
            |----------|--------|------|
            | Linux    | Onefile binary | `*-linux-x86_64-onefile` |
            | Linux    | AppImage       | `*.AppImage` |
            | Linux    | Debian package | `*.deb` |
            | Linux    | RPM package    | `*.rpm` |
            | Linux    | Portable tar.gz| `*.tar.gz` |
            | macOS    | App bundle zip | `*.app.zip` |
            | macOS    | DMG            | `*.dmg` |
            | Windows  | Installer .exe | `*-onefile.exe` |
            | Windows  | Portable zip   | `*-portable.zip` |
            | All      | Python wheels  | `*.whl` |

            ### Verify artifact integrity

            ```bash
            gh attestation verify <artifact> --repo ${{ github.repository }}
            ```

            ### Install Python wheel

            ```bash
            pip install PYPI_PROJECT_NAME==${{ needs.metadata.outputs.version }}
            ```
          draft:                 false
          prerelease:            ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: release-assets/**

  # ── 9. Publish to PyPI (OIDC trusted publishing) ─────────────────────────
  publish-pypi:
    name: Publish to PyPI
    needs: [wheels, release]
    runs-on: ubuntu-latest

    # "pypi" environment enforces branch/tag protections on PyPI's side.
    # Configure this environment in: Settings → Environments → pypi
    environment:
      name: pypi
      url:  https://pypi.org/p/PYPI_PROJECT_NAME  # TODO

    permissions:
      id-token: write   # OIDC token — the ONLY credential needed

    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444306234fca9e92e15bce55  # v4.1.8
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128c5a6aaff1a7  # v1.12.2
        # No username/password/token needed — OIDC handles authentication.
        # Before first publish: configure a Trusted Publisher on pypi.org
        # for this repo + workflow + environment.
